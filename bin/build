#!/bin/bash

# exit on error, unset vars
set -eu
# exit early for errors in pipelines
set -o pipefail

usage() {
    cat << EOF
usage: $0 [-n] [-d diff] major_version minor_version patch_version
EOF
}

# Options
cache=
diff=
while getopts ":nd:vh" opt; do
    case $opt in
        n)
            cache=--no-cache
            ;;
        d)
            diff=$OPTARG
            ;;
        v)
            set -x
            ;;
        h)
            usage
            exit
            ;;
        \?)
            echo "Invalid option: -$OPTARG" >&2
            usage
            exit 1
            ;;
        :)
            echo "Option -$OPTARG requires an argument." >&2
            exit 1
            ;;
    esac
done

# Positional arguments
shift "$((OPTIND-1))"
if [ "$#" -ne 3 ]; then
    echo "Illegal number of parameters"
    usage
    exit 1
fi
version_major=$1
version_minor=$2
version_patch=$3

# v_minor=$version_major.$version_minor
v_full=$version_major.$version_minor.$version_patch
echo
echo Building "$v_full"
echo

# set -o xtrace

## Dockerfile

write_version() {
    sed -i '' -E "s/^FROM httpd:([0-9\.]+)$/FROM httpd:${v_full}/" "$1"
}
write_version Dockerfile

## Build

# build image
docker build $cache -f Dockerfile -t "drupal-web:httpd-${v_full}" .

# post-build config
docker run --rm "drupal-web:httpd-${v_full}" /bin/cat /usr/local/apache2/conf/httpd.conf-default > \
    conf/httpd.conf-default

set +e

# examine config
if [[ -n "$diff" ]]; then
    $diff conf/httpd.conf-default       conf/httpd.conf-development            &
fi
