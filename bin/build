#!/bin/bash

# exit on error, unset vars
set -eu
# exit early for errors in pipelines
set -o pipefail
# debugging
# set -x

usage() {
    echo "Usage: $0 [-n] [-d diff] major_version minor_version patch_version" 1>&2
    exit 1
}

# Options
cache=""
diff=""
while getopts ":d:n" opt; do
  case $opt in
    n)
      cache=--no-cache
      ;;
    d)
      diff=$OPTARG
      ;;
    *)
      usage
      ;;
  esac
done

# Positional arguments
version_major=${@:$OPTIND:1}
version_minor=${@:$OPTIND+1:1}
version_patch=${@:$OPTIND+2:1}
if [ -z "${version_major}" ] || [ -z "${version_minor}" ] || [ -z "${version_patch}" ]; then
    usage
fi

v_minor=$version_major.$version_minor
v_full=$version_major.$version_minor.$version_patch
echo
echo Building "$v_full"
echo

set -o xtrace

## Dockerfile

write_version () {
    sed -i '' -E "s/^FROM httpd:([0-9\.]+)$/FROM httpd:${v_full}/" "$1"
}
write_version Dockerfile

## Build

# build image
docker build $cache -f Dockerfile -t "drupal-web:httpd-${v_full}" .

# post-build config
docker run --rm "drupal-web:httpd-${v_full}" /bin/cat /usr/local/apache2/conf/httpd.conf-default > \
    conf/httpd.conf-default

set +e

# examine config
if [[ -n "$diff" ]]; then
    $diff conf/httpd.conf-default       conf/httpd.conf-development            &
fi
